# ğŸ¯ Canary Deploy Profissional - Estilo Big Companies
# Deploy gradual: 5% â†’ 100% com health check profissional

name: Canary Deploy Professional

on:
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      canary_percentage:
        description: 'Porcentagem inicial do canary (5-50)'
        required: false
        default: '5'
      skip_canary:
        description: 'Pular canary e ir direto para 100%'
        type: boolean
        required: false
        default: false

env:
  # ğŸ¯ CONFIGURAÃ‡Ã•ES DO PROJETO - MUDE AQUI
  PROJECT_NAME: "rasparei"
  SITE_URL: "https://rasparei.com/"
  
  # ğŸ“Š CONFIGURAÃ‡Ã•ES DO CANARY
  CANARY_DURATION: "600"  # 10 minutos
  ERROR_THRESHOLD: "0.5"  # 0.5% de erro mÃ¡ximo
  LATENCY_THRESHOLD: "3000" # 3 segundos mÃ¡ximo

jobs:
  # ğŸš€ DEPLOY INICIAL (CANARY)
  canary-deploy:
    runs-on: ubuntu-latest
    outputs:
      canary_url: ${{ steps.deploy.outputs.preview-url }}
      canary_enabled: ${{ steps.config.outputs.canary_enabled }}
      canary_percentage: ${{ steps.config.outputs.canary_percentage }}
      
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ¯ Configurar Canary
        id: config
        run: |
          if [[ "${{ github.event.inputs.skip_canary }}" == "true" ]]; then
            echo "canary_enabled=false" >> $GITHUB_OUTPUT
            echo "ğŸš€ CANARY DESABILITADO - Deploy direto para 100%"
          else
            echo "canary_enabled=true" >> $GITHUB_OUTPUT
            PERCENTAGE="${{ github.event.inputs.canary_percentage || '5' }}"
            echo "canary_percentage=$PERCENTAGE" >> $GITHUB_OUTPUT
            echo "ğŸ¯ CANARY HABILITADO - Deploy para $PERCENTAGE% dos usuÃ¡rios"
          fi
        
      - name: ğŸš€ Deploy Canary
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_TEAM_ID }}
          vercel-project-id: ${{ env.PROJECT_NAME }}
          # Canary deployment (preview)
          vercel-args: '--prod=false'
          
      - name: ğŸ“± Notificar InÃ­cio Canary
        if: steps.config.outputs.canary_enabled == 'true'
        run: |
          PERCENTAGE="${{ steps.config.outputs.canary_percentage }}"
          MESSAGE="ğŸ¯ CANARY DEPLOY INICIADO%0A%0AğŸš€ Projeto: ${{ env.PROJECT_NAME }}%0AğŸ“Š Canary: $PERCENTAGE%% dos usuÃ¡rios%0Aâ° Monitoramento: ${{ env.CANARY_DURATION }}s%0AğŸ”— URL: ${{ steps.deploy.outputs.preview-url }}%0AğŸ“ Commit: ${GITHUB_SHA:0:7}%0A%0AğŸ¢ Deploy estilo Big Companies!"
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=$MESSAGE"

  # ğŸ“Š MONITORAMENTO PROFISSIONAL DO CANARY
  canary-monitor:
    runs-on: ubuntu-latest
    needs: [canary-deploy]
    if: needs.canary-deploy.outputs.canary_enabled == 'true'
    outputs:
      canary_success: ${{ steps.monitor.outputs.success }}
      error_rate: ${{ steps.monitor.outputs.error_rate }}
      avg_latency: ${{ steps.monitor.outputs.avg_latency }}
      total_requests: ${{ steps.monitor.outputs.total_requests }}
      
    steps:
      - name: ğŸ“Š Monitoramento Profissional
        id: monitor
        run: |
          CANARY_URL="${{ needs.canary-deploy.outputs.canary_url }}"
          MONITOR_TIME=${{ env.CANARY_DURATION }}
          ERROR_THRESHOLD=${{ env.ERROR_THRESHOLD }}
          LATENCY_THRESHOLD=${{ env.LATENCY_THRESHOLD }}
          
          echo "ğŸ” MONITORAMENTO PROFISSIONAL - ESTILO BIG COMPANIES"
          echo "=================================================="
          echo "ğŸ¯ URL Canary: $CANARY_URL"
          echo "â° DuraÃ§Ã£o: ${MONITOR_TIME}s"
          echo "ğŸš¨ Limite de erro: ${ERROR_THRESHOLD}%"
          echo "âš¡ Limite de latÃªncia: ${LATENCY_THRESHOLD}ms"
          echo ""
          
          # Contadores
          TOTAL_REQUESTS=0
          FAILED_REQUESTS=0
          TOTAL_LATENCY=0
          
          # Loop de monitoramento (a cada 30s por 10 minutos)
          END_TIME=$(($(date +%s) + MONITOR_TIME))
          
          while [ $(date +%s) -lt $END_TIME ]; do
            START_TIME=$(date +%s%3N)
            
            # Health Check Profissional
            RESPONSE=$(curl -s -w "HTTPSTATUS:%{http_code};TIME:%{time_total}" --max-time 10 "$CANARY_URL" || echo "HTTPSTATUS:000;TIME:999")
            STATUS=$(echo $RESPONSE | grep -o "HTTPSTATUS:[0-9]*" | cut -d: -f2)
            LATENCY_SEC=$(echo $RESPONSE | grep -o "TIME:[0-9.]*" | cut -d: -f2)
            LATENCY_MS=$(echo "$LATENCY_SEC * 1000" | bc -l 2>/dev/null || echo "999")
            
            TOTAL_REQUESTS=$((TOTAL_REQUESTS + 1))
            TOTAL_LATENCY=$(echo "$TOTAL_LATENCY + $LATENCY_MS" | bc -l)
            
            # Verificar se passou nos critÃ©rios profissionais
            if [[ "$STATUS" == "200" ]] && (( $(echo "$LATENCY_MS <= $LATENCY_THRESHOLD" | bc -l 2>/dev/null || echo "0") )); then
              echo "âœ… Request $TOTAL_REQUESTS: OK (${STATUS}, ${LATENCY_MS}ms)"
            else
              FAILED_REQUESTS=$((FAILED_REQUESTS + 1))
              echo "âŒ Request $TOTAL_REQUESTS: FAIL (${STATUS}, ${LATENCY_MS}ms)"
            fi
            
            # Aguardar 30s entre requests
            sleep 30
          done
          
          # Calcular mÃ©tricas finais
          if [ $TOTAL_REQUESTS -gt 0 ]; then
            ERROR_RATE=$(echo "scale=2; $FAILED_REQUESTS * 100 / $TOTAL_REQUESTS" | bc -l)
            AVG_LATENCY=$(echo "scale=0; $TOTAL_LATENCY / $TOTAL_REQUESTS" | bc -l)
          else
            ERROR_RATE="100"
            AVG_LATENCY="9999"
          fi
          
          echo ""
          echo "ğŸ“Š RESULTADOS FINAIS:"
          echo "ğŸ“ˆ Total requests: $TOTAL_REQUESTS"
          echo "âŒ Requests falharam: $FAILED_REQUESTS"
          echo "ğŸ“Š Taxa de erro: ${ERROR_RATE}%"
          echo "âš¡ LatÃªncia mÃ©dia: ${AVG_LATENCY}ms"
          echo ""
          
          # Avaliar sucesso usando critÃ©rios profissionais
          if (( $(echo "$ERROR_RATE <= $ERROR_THRESHOLD" | bc -l) )) && (( $(echo "$AVG_LATENCY <= $LATENCY_THRESHOLD" | bc -l) )); then
            echo "âœ… CANARY APROVADO - CRITÃ‰RIOS PROFISSIONAIS ATENDIDOS!"
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ CANARY REPROVADO - CRITÃ‰RIOS PROFISSIONAIS NÃƒO ATENDIDOS!"
            echo "success=false" >> $GITHUB_OUTPUT
          fi
          
          # Salvar mÃ©tricas
          echo "error_rate=$ERROR_RATE" >> $GITHUB_OUTPUT
          echo "avg_latency=$AVG_LATENCY" >> $GITHUB_OUTPUT
          echo "total_requests=$TOTAL_REQUESTS" >> $GITHUB_OUTPUT

  # ğŸš€ DEPLOY PARA PRODUÃ‡ÃƒO (100%)
  production-deploy:
    runs-on: ubuntu-latest
    needs: [canary-deploy, canary-monitor]
    if: always() && (needs.canary-monitor.outputs.canary_success == 'true' || needs.canary-deploy.outputs.canary_enabled == 'false')
    outputs:
      production_url: ${{ steps.deploy.outputs.preview-url }}
      
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸš€ Deploy ProduÃ§Ã£o (100%)
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_TEAM_ID }}
          vercel-project-id: ${{ env.PROJECT_NAME }}
          vercel-args: '--prod'
          
      - name: â³ Aguardar PropagaÃ§Ã£o
        run: sleep 45

  # ğŸ” HEALTH CHECK PROFISSIONAL DA PRODUÃ‡ÃƒO
  production-health-check:
    runs-on: ubuntu-latest
    needs: [production-deploy]
    if: always() && needs.production-deploy.result == 'success'
    outputs:
      health_passed: ${{ steps.health.outputs.health_passed }}
      status_code: ${{ steps.health.outputs.status_code }}
      response_time: ${{ steps.health.outputs.response_time }}
      errors_count: ${{ steps.health.outputs.errors_count }}
      error_details: ${{ steps.health.outputs.error_details }}
      
    steps:
      - name: ğŸ” Health Check Profissional da ProduÃ§Ã£o
        id: health
        run: |
          echo "ğŸ” Health Check ProduÃ§Ã£o - Estilo Big Companies"
          echo "=============================================="
          
          ERRORS=0
          
          # 1. AVAILABILITY CHECK - O mais importante
          echo "ğŸ“Š 1. Testando disponibilidade..."
          
          RESPONSE=$(curl -s -w "HTTPSTATUS:%{http_code};TIME:%{time_total}" --max-time 10 "${{ env.SITE_URL }}" || echo "HTTPSTATUS:000;TIME:999")
          STATUS=$(echo $RESPONSE | grep -o "HTTPSTATUS:[0-9]*" | cut -d: -f2)
          TIME=$(echo $RESPONSE | grep -o "TIME:[0-9.]*" | cut -d: -f2)
          
          echo "   Status: $STATUS"
          echo "   Tempo: ${TIME}s"
          
          # 2. CRITICAL ERRORS ONLY - SÃ³ erros que realmente importam
          if [[ "$STATUS" != "200" ]]; then
            echo "âŒ FALHA CRÃTICA: Site nÃ£o responde (HTTP $STATUS)"
            ERRORS=$((ERRORS + 1))
          elif (( $(echo "$TIME > 5.0" | bc -l 2>/dev/null || echo "0") )); then
            echo "âŒ FALHA CRÃTICA: Site muito lento (${TIME}s > 5s)"
            ERRORS=$((ERRORS + 1))
          else
            echo "âœ… Site disponÃ­vel e responsivo"
          fi
          
          # 3. BASIC CONTENT CHECK - SÃ³ verificar se nÃ£o Ã© pÃ¡gina de erro
          echo "ğŸ“„ 2. Verificando conteÃºdo bÃ¡sico..."
          
          CONTENT=$(curl -s --max-time 10 "${{ env.SITE_URL }}" || echo "")
          CONTENT_SIZE=${#CONTENT}
          
          echo "   Tamanho: $CONTENT_SIZE chars"
          
          if [[ $CONTENT_SIZE -lt 1000 ]]; then
            echo "âŒ FALHA CRÃTICA: ConteÃºdo muito pequeno - possÃ­vel erro"
            ERRORS=$((ERRORS + 1))
          elif echo "$CONTENT" | grep -qi "500\|internal server error\|application error\|fatal error\|error occurred\|something went wrong\|bailout_to_client_side_rendering"; then
            echo "âŒ FALHA CRÃTICA: PÃ¡gina de erro detectada"
            
            # Mostrar qual erro foi detectado para debug
            if echo "$CONTENT" | grep -qi "bailout_to_client_side_rendering"; then
              echo "   ğŸ” Erro especÃ­fico: BAILOUT_TO_CLIENT_SIDE_RENDERING (Next.js hydration)"
            elif echo "$CONTENT" | grep -qi "500"; then
              echo "   ğŸ” Erro especÃ­fico: HTTP 500 (Internal Server Error)"
            elif echo "$CONTENT" | grep -qi "application error"; then
              echo "   ğŸ” Erro especÃ­fico: Application Error"
            else
              echo "   ğŸ” Erro especÃ­fico: Erro genÃ©rico detectado no conteÃºdo"
            fi
            
            ERRORS=$((ERRORS + 1))
          else
            echo "âœ… ConteÃºdo carregado normalmente"
          fi
          
          # 4. FINAL RESULT - SÃ³ falha se realmente crÃ­tico
          echo ""
          echo "ğŸ“Š RESULTADO FINAL:"
          echo "âŒ Falhas crÃ­ticas: $ERRORS"
          
          # Coletar detalhes do erro
          ERROR_DETAILS=""
          if [[ "$ERRORS" -gt 0 ]]; then
            if [[ "$STATUS" != "200" ]]; then
              ERROR_DETAILS="Site nÃ£o responde (HTTP $STATUS)"
            elif (( $(echo "$TIME > 5.0" | bc -l 2>/dev/null || echo "0") )); then
              ERROR_DETAILS="Site muito lento (${TIME}s)"
            elif echo "$CONTENT" | grep -qi "bailout_to_client_side_rendering"; then
              ERROR_DETAILS="Erro de hidrataÃ§Ã£o Next.js"
            elif echo "$CONTENT" | grep -qi "500"; then
              ERROR_DETAILS="Erro interno do servidor"
            elif echo "$CONTENT" | grep -qi "application error"; then
              ERROR_DETAILS="Erro da aplicaÃ§Ã£o"
            else
              ERROR_DETAILS="ConteÃºdo muito pequeno ou erro genÃ©rico"
            fi
          fi
          
          # Salvar informaÃ§Ãµes
          echo "errors_count=$ERRORS" >> $GITHUB_OUTPUT
          echo "status_code=$STATUS" >> $GITHUB_OUTPUT
          echo "response_time=$TIME" >> $GITHUB_OUTPUT
          echo "error_details=$ERROR_DETAILS" >> $GITHUB_OUTPUT
          
          if [[ "$ERRORS" -gt 0 ]]; then
            echo ""
            echo "ğŸš¨ HEALTH CHECK FALHOU - PROBLEMA CRÃTICO DETECTADO"
            echo "health_passed=false" >> $GITHUB_OUTPUT
            exit 1
          else
            echo ""
            echo "âœ… HEALTH CHECK PASSOU - SITE FUNCIONANDO"
            echo "health_passed=true" >> $GITHUB_OUTPUT
          fi

  # ğŸ”„ ROLLBACK SE NECESSÃRIO
  rollback:
    runs-on: ubuntu-latest
    needs: [production-deploy, production-health-check, canary-monitor]
    if: always() && (needs.production-health-check.outputs.health_passed == 'false' || needs.canary-monitor.outputs.canary_success == 'false')
    outputs:
      rollback_executed: ${{ steps.rollback.outputs.executed }}
      
    steps:
      - name: ğŸ”„ Rollback AutomÃ¡tico
        id: rollback
        run: |
          echo "ğŸš¨ EXECUTANDO ROLLBACK AUTOMÃTICO..."
          npm install -g vercel@latest
          
          # Buscar deployment anterior
          DEPLOYMENTS=$(npx vercel ls ${{ env.PROJECT_NAME }} --token="${{ secrets.VERCEL_TOKEN }}" --scope="${{ secrets.VERCEL_SCOPE }}" -m 10)
          echo "ğŸ“‹ Listando deployments..."
          echo "$DEPLOYMENTS"
          
          # Buscar APENAS deployments Ready para rollback
          echo "ğŸ” Procurando deployments Ready para rollback..."
          READY_DEPLOYMENTS=$(echo "$DEPLOYMENTS" | grep "â— Ready" | grep "Production" || true)
          echo "ğŸ“‹ Deployments Ready encontrados:"
          echo "$READY_DEPLOYMENTS"
          
          # Contar quantos deployments Ready temos
          READY_COUNT=$(echo "$READY_DEPLOYMENTS" | grep -c "https://" || echo "0")
          echo "ğŸ“Š Total de deployments Ready: $READY_COUNT"
          
          if [ "$READY_COUNT" -ge 2 ]; then
            # Pegar o segundo deployment Ready (o primeiro Ã© o atual que falhou)
            PREVIOUS_URL=$(echo "$READY_DEPLOYMENTS" | sed -n '2p' | awk '{print $1}')
            echo "ğŸ”„ Executando rollback para o deployment anterior: $PREVIOUS_URL"
          elif [ "$READY_COUNT" -eq 1 ]; then
            # Se sÃ³ tem 1, usar ele mesmo (melhor que nada)
            PREVIOUS_URL=$(echo "$READY_DEPLOYMENTS" | head -1 | awk '{print $1}')
            echo "ğŸ”„ SÃ³ hÃ¡ 1 deployment Ready, usando ele: $PREVIOUS_URL"
          else
            echo "âŒ Nenhum deployment Ready encontrado"
            echo "executed=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Executar o rollback
          if [ -n "$PREVIOUS_URL" ]; then
            npx vercel promote "$PREVIOUS_URL" --token="${{ secrets.VERCEL_TOKEN }}" --scope="${{ secrets.VERCEL_SCOPE }}" --yes
            
            if [ $? -eq 0 ]; then
              echo "âœ… ROLLBACK EXECUTADO!"
              echo "executed=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ ROLLBACK FALHOU"
              echo "executed=false" >> $GITHUB_OUTPUT
            fi
          fi

  # ğŸ“± NOTIFICAÃ‡Ã•ES FINAIS
  notify:
    runs-on: ubuntu-latest
    needs: [canary-deploy, canary-monitor, production-deploy, production-health-check, rollback]
    if: always()
    
    steps:
      - name: ğŸ“± NotificaÃ§Ã£o Final
        run: |
          CANARY_ENABLED="${{ needs.canary-deploy.outputs.canary_enabled }}"
          CANARY_SUCCESS="${{ needs.canary-monitor.outputs.canary_success }}"
          HEALTH_PASSED="${{ needs.production-health-check.outputs.health_passed }}"
          ERROR_RATE="${{ needs.canary-monitor.outputs.error_rate }}"
          AVG_LATENCY="${{ needs.canary-monitor.outputs.avg_latency }}"
          TOTAL_REQUESTS="${{ needs.canary-monitor.outputs.total_requests }}"
          STATUS_CODE="${{ needs.production-health-check.outputs.status_code }}"
          RESPONSE_TIME="${{ needs.production-health-check.outputs.response_time }}"
          ERROR_DETAILS="${{ needs.production-health-check.outputs.error_details }}"
          ROLLBACK="${{ needs.rollback.outputs.rollback_executed || 'nÃ£o executado' }}"
          
          if [[ "$CANARY_ENABLED" == "false" ]]; then
            # Deploy direto sem canary
            if [[ "$HEALTH_PASSED" == "true" ]]; then
              MESSAGE="âœ… DEPLOY DIRETO OK: ${{ env.PROJECT_NAME }}%0A%0AğŸš€ Deploy 100%% sem canary%0AğŸ“Š Status: $STATUS_CODE%0Aâš¡ Tempo: ${RESPONSE_TIME}s%0AğŸŒ ${{ env.SITE_URL }}%0AğŸ“ Commit: ${GITHUB_SHA:0:7}%0A%0AğŸ¢ Deploy estilo Big Companies!"
            else
              MESSAGE="ğŸš¨ DEPLOY DIRETO FALHOU: ${{ env.PROJECT_NAME }}%0A%0AâŒ Health check falhou%0AğŸ” Erro: $ERROR_DETAILS%0AğŸ“Š Status: $STATUS_CODE%0AğŸ”„ Rollback: $ROLLBACK%0AğŸ“ Commit: ${GITHUB_SHA:0:7}%0AğŸ”¥ INTERVENÃ‡ÃƒO NECESSÃRIA!"
            fi
          else
            # Deploy com canary
            if [[ "$CANARY_SUCCESS" == "true" && "$HEALTH_PASSED" == "true" ]]; then
              MESSAGE="ğŸ¯ CANARY DEPLOY SUCESSO: ${{ env.PROJECT_NAME }}%0A%0Aâœ… Canary aprovado (erro: ${ERROR_RATE}%%)%0Aâœ… ProduÃ§Ã£o funcionando%0Aâš¡ LatÃªncia canary: ${AVG_LATENCY}ms%0AğŸ“Š Requests canary: $TOTAL_REQUESTS%0AğŸ“Š Status produÃ§Ã£o: $STATUS_CODE%0Aâš¡ Tempo produÃ§Ã£o: ${RESPONSE_TIME}s%0AğŸŒ 100%% dos usuÃ¡rios protegidos%0AğŸ“ Commit: ${GITHUB_SHA:0:7}%0A%0AğŸ¢ Deploy estilo Big Companies!"
            elif [[ "$CANARY_SUCCESS" == "false" ]]; then
              MESSAGE="ğŸš¨ CANARY REPROVADO: ${{ env.PROJECT_NAME }}%0A%0AâŒ Canary falhou (erro: ${ERROR_RATE}%%)%0Aâš¡ LatÃªncia: ${AVG_LATENCY}ms%0AğŸ“Š Requests: $TOTAL_REQUESTS%0AğŸ”„ Rollback: $ROLLBACK%0AğŸ“ Commit: ${GITHUB_SHA:0:7}%0A%0Aâœ… 95%% DOS USUÃRIOS PROTEGIDOS!"
            else
              MESSAGE="ğŸš¨ PRODUÃ‡ÃƒO FALHOU: ${{ env.PROJECT_NAME }}%0A%0Aâœ… Canary passou%0AâŒ ProduÃ§Ã£o falhou%0AğŸ” Erro: $ERROR_DETAILS%0AğŸ“Š Status: $STATUS_CODE%0AğŸ”„ Rollback: $ROLLBACK%0AğŸ“ Commit: ${GITHUB_SHA:0:7}%0AğŸ”¥ INTERVENÃ‡ÃƒO NECESSÃRIA!"
            fi
          fi
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=$MESSAGE"
