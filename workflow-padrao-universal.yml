# ğŸš€ Workflow PadrÃ£o Universal - Para TODOS os Projetos
# Copie este arquivo para: .github/workflows/deploy.yml
# Mude apenas 3 linhas e funciona para qualquer projeto

name: Deploy Universal

on:
  push:
    branches: [main, master]
  workflow_dispatch:
  schedule:
    # Verifica deploys manuais a cada 30 minutos
    - cron: '*/30 * * * *'

jobs:
  deploy:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸš€ Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_TEAM_ID }}
          # ğŸ¯ MUDE AQUI: nome do seu projeto no Vercel
          vercel-project-id: SEU_PROJETO_AQUI
          
      - name: â³ Aguardar Deploy
        run: sleep 20
          
      - name: ğŸ“± Notificar InÃ­cio
        run: |
          MESSAGE="ğŸš€ Deploy iniciado: ${{ github.repository }}%0A%0AğŸ“Š Commit: ${GITHUB_SHA:0:7}%0AğŸ‘¤ Por: ${{ github.actor }}"
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=$MESSAGE"

  health-check:
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    
    steps:
      - name: ğŸ” Health Check Detalhado
        id: health
        run: |
          # ğŸ¯ MUDE AQUI: URL do seu projeto
          URL="https://SEU_SITE_AQUI.com/"
          
          echo "ğŸ” Verificando: $URL"
          
          ERRORS=0
          ERROR_DETAILS=""
          
          # 1. Testar conectividade
          STATUS=$(curl -s -w "%{http_code}" -o /tmp/page.html --max-time 30 "$URL" || echo "000")
          PAGE_SIZE=$(wc -c < /tmp/page.html 2>/dev/null || echo "0")
          
          echo "ğŸ“Š Status HTTP: $STATUS"
          echo "ğŸ“ Tamanho: $PAGE_SIZE bytes"
          
          # 2. Verificar erros
          if [[ "$STATUS" != "200" ]]; then
            echo "âŒ Site nÃ£o responde (Status: $STATUS)"
            ERROR_DETAILS="${ERROR_DETAILS}â€¢ Site nÃ£o responde (HTTP $STATUS)%0A"
            ERRORS=$((ERRORS + 1))
          fi
          
          if [[ "$PAGE_SIZE" -lt 5000 ]]; then
            echo "âŒ PÃ¡gina muito pequena ($PAGE_SIZE bytes)"
            ERROR_DETAILS="${ERROR_DETAILS}â€¢ PÃ¡gina muito pequena ($PAGE_SIZE bytes)%0A"
            ERRORS=$((ERRORS + 1))
          fi
          
          # 3. Verificar recursos bÃ¡sicos
          if [[ "$STATUS" == "200" ]]; then
            JS_COUNT=$(grep -o '<script[^>]*src="[^"]*"' /tmp/page.html | wc -l || echo "0")
            CSS_COUNT=$(grep -o '<link[^>]*rel="stylesheet"' /tmp/page.html | wc -l || echo "0")
            
            echo "ğŸ“œ Scripts: $JS_COUNT"
            echo "ğŸ¨ Estilos: $CSS_COUNT"
            
            if [[ "$JS_COUNT" -lt 2 ]]; then
              echo "âŒ Poucos scripts JS ($JS_COUNT)"
              ERROR_DETAILS="${ERROR_DETAILS}â€¢ Poucos scripts JS ($JS_COUNT/2)%0A"
              ERRORS=$((ERRORS + 1))
            fi
            
            if [[ "$CSS_COUNT" -lt 1 ]]; then
              echo "âŒ Poucos arquivos CSS ($CSS_COUNT)"
              ERROR_DETAILS="${ERROR_DETAILS}â€¢ Poucos arquivos CSS ($CSS_COUNT/1)%0A"
              ERRORS=$((ERRORS + 1))
            fi
          fi
          
          rm -f /tmp/page.html
          
          # Salvar resultados
          echo "errors_count=$ERRORS" >> $GITHUB_OUTPUT
          echo "error_details=$ERROR_DETAILS" >> $GITHUB_OUTPUT
          
          echo ""
          echo "ğŸ“Š RESULTADO: $ERRORS erros"
          
          if [[ "$ERRORS" -gt 0 ]]; then
            echo "ğŸš¨ HEALTH CHECK FALHOU!"
            echo "health_passed=false" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "âœ… HEALTH CHECK PASSOU!"
            echo "health_passed=true" >> $GITHUB_OUTPUT
          fi

  rollback:
    runs-on: ubuntu-latest
    needs: [deploy, health-check]
    if: always() && needs.health-check.outputs.health_passed == 'false' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    
    steps:
      - name: ğŸ”„ Rollback AutomÃ¡tico
        id: rollback
        run: |
          echo "ğŸš¨ EXECUTANDO ROLLBACK AUTOMÃTICO..."
          npm install -g vercel@latest
          
          # ğŸ¯ MUDE AQUI: mesmo nome do projeto da linha 32
          echo "ğŸ” Buscando deployments anteriores..."
          DEPLOYMENTS=$(npx vercel ls SEU_PROJETO_AQUI --token="${{ secrets.VERCEL_TOKEN }}" --scope="${{ secrets.VERCEL_SCOPE }}" -m 10)
          echo "ğŸ“Š Deployments encontrados:"
          echo "$DEPLOYMENTS"
          
          PREVIOUS_URL=$(echo "$DEPLOYMENTS" | grep -E "https://.*\.vercel\.app" | sed -n '2p' | awk '{print $1}')
          
          if [ -z "$PREVIOUS_URL" ]; then
            echo "âŒ Deployment anterior nÃ£o encontrado"
            echo "ğŸ” Tentando encontrar deployment estÃ¡vel..."
            STABLE_URL=$(echo "$DEPLOYMENTS" | grep -E "https://.*\.vercel\.app" | head -2 | tail -1 | awk '{print $1}')
            
            if [ -n "$STABLE_URL" ]; then
              echo "ğŸ”„ Usando deployment estÃ¡vel: $STABLE_URL"
              npx vercel promote "$STABLE_URL" --token="${{ secrets.VERCEL_TOKEN }}" --scope="${{ secrets.VERCEL_SCOPE }}" --yes
              echo "rollback_executed=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ Nenhum deployment disponÃ­vel"
              echo "rollback_executed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "ğŸ”„ Executando rollback para: $PREVIOUS_URL"
            npx vercel promote "$PREVIOUS_URL" --token="${{ secrets.VERCEL_TOKEN }}" --scope="${{ secrets.VERCEL_SCOPE }}" --yes
            
            if [ $? -eq 0 ]; then
              echo "âœ… ROLLBACK EXECUTADO!"
              echo "ğŸ§ª Aguardando 30s para estabilizar..."
              sleep 30
              
              # Verificar se funcionou
              ROLLBACK_STATUS=$(curl -s -w "%{http_code}" -o /dev/null --max-time 30 "https://SEU_SITE_AQUI.com/" || echo "000")
              
              if [[ "$ROLLBACK_STATUS" == "200" ]]; then
                echo "âœ… ROLLBACK VERIFICADO - SITE FUNCIONANDO!"
                echo "rollback_executed=true" >> $GITHUB_OUTPUT
              else
                echo "âŒ ROLLBACK FALHOU (Status: $ROLLBACK_STATUS)"
                echo "rollback_executed=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "âŒ Comando de rollback falhou"
              echo "rollback_executed=false" >> $GITHUB_OUTPUT
            fi
          fi

  notify:
    runs-on: ubuntu-latest
    needs: [health-check, rollback]
    if: always()
    
    steps:
      - name: ğŸ“± NotificaÃ§Ã£o Final
        run: |
          HEALTH_PASSED="${{ needs.health-check.outputs.health_passed }}"
          ERRORS="${{ needs.health-check.outputs.errors_count }}"
          ERROR_DETAILS="${{ needs.health-check.outputs.error_details }}"
          ROLLBACK="${{ needs.rollback.outputs.rollback_executed || 'nÃ£o executado' }}"
          
          if [[ "$HEALTH_PASSED" == "true" ]]; then
            MESSAGE="âœ… Deploy OK: ${{ github.repository }}%0A%0AğŸŒ Site funcionando perfeitamente%0AğŸ“Š Commit: ${GITHUB_SHA:0:7}%0AğŸ‘¤ Por: ${{ github.actor }}%0AğŸ•’ $(date +'%H:%M')"
          else
            if [[ "$ROLLBACK" == "true" ]]; then
              MESSAGE="ğŸ”„ ROLLBACK EXECUTADO: ${{ github.repository }}%0A%0AğŸš¨ Deploy falhou ($ERRORS erros)%0Aâœ… Site revertido automaticamente%0AğŸ“Š Commit: ${GITHUB_SHA:0:7}%0Aâœ… USUÃRIOS PROTEGIDOS!"
            else
              MESSAGE="ğŸš¨ DEPLOY FALHOU: ${{ github.repository }}%0A%0AâŒ Health check: $ERRORS erros%0A%0AğŸ“‹ DETALHES:%0A$ERROR_DETAILS%0AâŒ Rollback: $ROLLBACK%0AğŸ“Š Commit: ${GITHUB_SHA:0:7}%0A%0AğŸ”¥ INTERVENÃ‡ÃƒO NECESSÃRIA!"
            fi
          fi
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=$MESSAGE"
