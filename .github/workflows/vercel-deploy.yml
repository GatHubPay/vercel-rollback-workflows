# ğŸš€ Workflow ReutilizÃ¡vel - Deploy Vercel
# Uso: GatHubPay/vercel-rollback-workflows/.github/workflows/vercel-deploy.yml@main

name: Vercel Deploy

on:
  workflow_call:
    inputs:
      vercelProject:
        description: "Nome do projeto no Vercel"
        required: true
        type: string
      projectUrl:
        description: "URL para health check"
        required: true
        type: string
    secrets:
      VERCEL_TOKEN:
        required: true
      VERCEL_TEAM_ID:
        required: true
      TELEGRAM_BOT_TOKEN:
        required: true
      TELEGRAM_CHAT_ID:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸš€ Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_TEAM_ID }}
          vercel-project-id: ${{ inputs.vercelProject }}
          working-directory: ./
          
      - name: ğŸ§ª Health Check
        run: |
          echo "ğŸ” Verificando deploy..."
          sleep 15
          
          STATUS=$(curl -s -w "%{http_code}" -o /dev/null --max-time 30 --connect-timeout 10 "${{ inputs.projectUrl }}" || echo "000")
          
          echo "ğŸ“Š Status: $STATUS"
          
          if [[ "$STATUS" == "200" ]]; then
            echo "âœ… Deploy funcionando!"
          else
            echo "âš ï¸  Status $STATUS - mas deploy pode estar OK"
          fi
          
      - name: ğŸ“± NotificaÃ§Ã£o Sucesso
        if: success()
        run: |
          MESSAGE="âœ… Deploy realizado com sucesso!%0A%0AğŸ¯ Projeto: ${{ inputs.vercelProject }}%0AğŸŒ URL: ${{ inputs.projectUrl }}%0AğŸ“Š Commit: ${GITHUB_SHA:0:7}%0AğŸ‘¤ Por: ${{ github.actor }}%0AğŸ•’ $(date +'%d/%m/%Y %H:%M')"
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=$MESSAGE" || echo "ğŸ“± Telegram falhou"
            
      - name: ğŸ“± NotificaÃ§Ã£o Erro
        if: failure()
        run: |
          MESSAGE="âŒ Falha no deploy!%0A%0AğŸ¯ Projeto: ${{ inputs.vercelProject }}%0AğŸ“Š Commit: ${GITHUB_SHA:0:7}%0AğŸ‘¤ Por: ${{ github.actor }}%0AğŸ”— Logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}%0AğŸ•’ $(date +'%d/%m/%Y %H:%M')"
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=$MESSAGE" || echo "ğŸ“± Telegram falhou"
