# üìä Relat√≥rio Di√°rio - GatHubPay Softhouse
# Envia relat√≥rio di√°rio de todos os deploys

name: Relat√≥rio Di√°rio

on:
  schedule:
    - cron: '0 9 * * *'  # Todo dia √†s 9h da manh√£
  workflow_dispatch:      # Permite executar manualmente

jobs:
  daily-report:
    runs-on: ubuntu-latest
    
    steps:
      - name: üìä Gerar Relat√≥rio Di√°rio
        run: |
          # Data atual
          TODAY=$(date '+%Y-%m-%d')
          YESTERDAY=$(date -d "yesterday" '+%Y-%m-%d')
          
          echo "üìä Gerando relat√≥rio para $TODAY..."
          
          # Simular m√©tricas (em produ√ß√£o, voc√™ coletaria dados reais)
          TOTAL_DEPLOYS=47
          SUCCESS_DEPLOYS=45
          ROLLBACKS=2
          SUCCESS_RATE=$(echo "scale=1; $SUCCESS_DEPLOYS * 100 / $TOTAL_DEPLOYS" | bc)
          ROLLBACK_RATE=$(echo "scale=1; $ROLLBACKS * 100 / $TOTAL_DEPLOYS" | bc)
          
          # Projetos com problema (exemplo)
          PROBLEM_PROJECTS="‚Ä¢ projeto-cliente-x: rollback executado%0A‚Ä¢ app-cliente-y: health check falhou"
          
          # Top projetos (exemplo)
          TOP_PROJECTS="‚Ä¢ loja-cliente-a%0A‚Ä¢ dashboard-cliente-b%0A‚Ä¢ landing-cliente-c"
          
          # Montar mensagem
          MESSAGE="üìä RELAT√ìRIO DI√ÅRIO - GatHubPay%0A%0A‚úÖ Deploys hoje: $TOTAL_DEPLOYS%0A‚úÖ Sucessos: $SUCCESS_DEPLOYS ($SUCCESS_RATE%%)%0AüîÑ Rollbacks: $ROLLBACKS ($ROLLBACK_RATE%%)%0A‚è∞ Tempo m√©dio: 2.1min%0A%0Aüö® Projetos com problema:%0A$PROBLEM_PROJECTS%0A%0AüèÜ Top projetos (100%% sucesso):%0A$TOP_PROJECTS%0A%0AüìÖ Data: $TODAY%0A‚è∞ Gerado √†s: $(date '+%H:%M:%S')"
          
          # Enviar para Telegram
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=$MESSAGE" \
            -d "parse_mode=HTML" || echo "‚ö†Ô∏è Falha ao enviar relat√≥rio"
          
          echo "‚úÖ Relat√≥rio di√°rio enviado!"
