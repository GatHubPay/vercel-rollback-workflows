# ğŸ¯ Monitoramento de LÃ³gica de NegÃ³cio
# Testa funcionalidades crÃ­ticas como PIX, login, compras

name: Monitor Business Logic

on:
  schedule:
    - cron: '*/30 * * * *'  # A cada 30 minutos (menos frequente)
  workflow_dispatch:         # Permite executar manualmente

jobs:
  test-critical-functions:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        # ğŸ¯ TESTES DE FUNCIONALIDADES CRÃTICAS:
        test:
          - name: "pix-integration"
            site: "rasparei"
            url: "https://rasparei.com/api/pix/status"
            expected: "ok"
            critical: true
          # - name: "user-balance"
          #   site: "rasparei"
          #   url: "https://rasparei.com/api/user/balance"
          #   expected: "balance"
          #   critical: true
          # - name: "admin-dashboard"
          #   site: "admin-raspaganha"
          #   url: "https://admin.raspaganha.sa.com/api/health"
          #   expected: "healthy"
          #   critical: true
          # â• Adicione mais testes conforme necessÃ¡rio
      fail-fast: false  # Continua testando outras funÃ§Ãµes mesmo se uma falhar
    
    steps:
      - name: ğŸ¯ Testar ${{ matrix.test.name }}
        run: |
          echo "ğŸ¯ Testando funÃ§Ã£o crÃ­tica: ${{ matrix.test.name }}"
          echo "ğŸŒ Endpoint: ${{ matrix.test.url }}"
          
          # Fazer requisiÃ§Ã£o para endpoint de teste
          RESPONSE=$(curl -s -w "HTTPSTATUS:%{http_code};TIME:%{time_total}" \
                         --max-time 30 \
                         "${{ matrix.test.url }}" || echo "HTTPSTATUS:000;TIME:999")
          
          STATUS=$(echo $RESPONSE | grep -o "HTTPSTATUS:[0-9]*" | cut -d: -f2)
          TIME=$(echo $RESPONSE | grep -o "TIME:[0-9.]*" | cut -d: -f2)
          CONTENT=$(curl -s --max-time 30 "${{ matrix.test.url }}" || echo "")
          
          echo "ğŸ“Š Status: $STATUS"
          echo "âš¡ Tempo: ${TIME}s"
          echo "ğŸ“„ Resposta: ${CONTENT:0:200}..."
          
          # Verificar problemas
          PROBLEMS=""
          FUNCTION_OK=true
          
          if [[ "$STATUS" != "200" ]]; then
            PROBLEMS="${PROBLEMS}â€¢ API nÃ£o responde (HTTP $STATUS)%0A"
            FUNCTION_OK=false
          elif [[ -z "$CONTENT" ]]; then
            PROBLEMS="${PROBLEMS}â€¢ Resposta vazia da API%0A"
            FUNCTION_OK=false
          elif ! echo "$CONTENT" | grep -qi "${{ matrix.test.expected }}"; then
            PROBLEMS="${PROBLEMS}â€¢ Resposta inesperada (nÃ£o contÃ©m '${{ matrix.test.expected }}')%0A"
            FUNCTION_OK=false
          elif (( $(echo "$TIME > 10.0" | bc -l 2>/dev/null || echo "0") )); then
            PROBLEMS="${PROBLEMS}â€¢ API muito lenta (${TIME}s)%0A"
            FUNCTION_OK=false
          fi
          
          # Verificar erros especÃ­ficos na resposta
          if echo "$CONTENT" | grep -qi "error\|failed\|exception\|timeout"; then
            PROBLEMS="${PROBLEMS}â€¢ Erro detectado na resposta da API%0A"
            FUNCTION_OK=false
          fi
          
          # Enviar alerta se funÃ§Ã£o crÃ­tica falhar
          if [[ "$FUNCTION_OK" == "false" && "${{ matrix.test.critical }}" == "true" ]]; then
            MESSAGE="ğŸš¨ FUNÃ‡ÃƒO CRÃTICA FALHANDO!%0A%0AğŸ¯ FunÃ§Ã£o: ${{ matrix.test.name }}%0AğŸ¢ Site: ${{ matrix.test.site }}%0AğŸŒ Endpoint: ${{ matrix.test.url }}%0AğŸ“Š Status: $STATUS%0Aâš¡ Tempo: ${TIME}s%0AğŸ“… Data: $(TZ='America/Sao_Paulo' date '+%d/%m/%Y')%0Aâ° Hora: $(TZ='America/Sao_Paulo' date '+%H:%M:%S') (BrasÃ­lia)%0A%0AğŸ” Problemas:%0A$PROBLEMS%0AğŸ”¥ VERIFICAR URGENTE - USUÃRIOS AFETADOS!"
            
            # Enviar alerta crÃ­tico
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
              -d "text=$MESSAGE" || echo "âš ï¸ Falha ao enviar alerta"
            
            echo "ğŸš¨ ALERTA CRÃTICO ENVIADO para ${{ matrix.test.name }}!"
            exit 1  # Falha o job para aparecer no GitHub
          elif [[ "$FUNCTION_OK" == "false" ]]; then
            echo "âš ï¸ FunÃ§Ã£o ${{ matrix.test.name }} com problema (nÃ£o crÃ­tica)"
          else
            echo "âœ… FunÃ§Ã£o ${{ matrix.test.name }} funcionando normalmente"
          fi

  # ğŸ“Š RESUMO DAS FUNÃ‡Ã•ES CRÃTICAS
  summary:
    runs-on: ubuntu-latest
    needs: test-critical-functions
    if: always()
    
    steps:
      - name: ğŸ“Š Resumo das FunÃ§Ãµes CrÃ­ticas
        run: |
          echo "ğŸ¯ Monitoramento de lÃ³gica de negÃ³cio executado"
          echo "â° HorÃ¡rio: $(date '+%Y-%m-%d %H:%M:%S')"
          
          # Se houver falhas, elas jÃ¡ foram reportadas individualmente
          echo "âœ… PrÃ³xima verificaÃ§Ã£o em 30 minutos"
