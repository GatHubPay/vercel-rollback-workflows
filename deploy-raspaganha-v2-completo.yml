# ğŸ® Deploy RaspaGanha V2 - Monitoramento Completo
# Monitora QUALQUER deploy em produÃ§Ã£o + Health Check + Rollback

name: Deploy RaspaGanha V2

on:
  push:
    branches: [main, master]
  workflow_dispatch:
  schedule:
    # Executa a cada 30 minutos para verificar deploys manuais
    - cron: '*/30 * * * *'

jobs:
  # Job 1: Deploy automÃ¡tico (sÃ³ para main/master)
  deploy:
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸš€ Deploy to Vercel
        uses: amondnet/vercel-action@v25
        id: vercel-deploy
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_TEAM_ID }}
          vercel-project-id: rasparei
          
      - name: â³ Aguardar Deploy
        run: |
          echo "â³ Aguardando deploy automÃ¡tico ficar disponÃ­vel..."
          sleep 20
          
      - name: ğŸ“± Notificar Deploy Iniciado
        run: |
          MESSAGE="ğŸš€ Deploy RaspaGanha V2 iniciado%0A%0AğŸ“Š Commit: ${GITHUB_SHA:0:7}%0AğŸ‘¤ Por: ${{ github.actor }}%0AğŸ”„ Aguardando health check..."
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=$MESSAGE"

  # Job 2: Health Check (sempre executa)
  health-check:
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    
    steps:
      - name: ğŸ” Health Check Ultra Rigoroso
        id: health-check
        run: |
          echo "ğŸ” Verificando aplicaÃ§Ã£o em produÃ§Ã£o..."
          echo "ğŸŒ URL: https://rasparei.com/"
          
          ERRORS=0
          WARNINGS=0
          DEPLOY_SOURCE="desconhecido"
          
          # Detectar fonte do deploy
          if [[ "${{ github.event_name }}" == "push" ]]; then
            DEPLOY_SOURCE="push automÃ¡tico (branch: ${{ github.ref_name }})"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            DEPLOY_SOURCE="deploy manual via GitHub"
          elif [[ "${{ github.event_name }}" == "schedule" ]]; then
            DEPLOY_SOURCE="verificaÃ§Ã£o periÃ³dica (possÃ­vel deploy manual no Vercel)"
          fi
          
          echo "ğŸ“‹ Fonte: $DEPLOY_SOURCE"
          
          # 1. Verificar conectividade
          echo "ğŸ“Š 1. Testando conectividade..."
          STATUS=$(curl -s -w "%{http_code}" -o /tmp/page.html --max-time 30 "https://rasparei.com/" || echo "000")
          echo "Status HTTP: $STATUS"
          
          if [[ "$STATUS" != "200" ]]; then
            echo "âŒ ERRO CRÃTICO: Site nÃ£o responde (Status: $STATUS)"
            ERRORS=$((ERRORS + 1))
          fi
          
          # 2. Verificar tamanho da pÃ¡gina
          PAGE_SIZE=$(wc -c < /tmp/page.html 2>/dev/null || echo "0")
          echo "ğŸ“ 2. Tamanho: $PAGE_SIZE bytes"
          
          if [[ "$PAGE_SIZE" -lt 10000 ]]; then
            echo "âŒ ERRO: PÃ¡gina muito pequena ($PAGE_SIZE bytes)"
            ERRORS=$((ERRORS + 1))
          fi
          
          # 3. Verificar erros JavaScript
          echo "ğŸ“œ 3. Verificando erros JS..."
          if grep -qi "error\|exception\|undefined\|null is not\|cannot read" /tmp/page.html; then
            echo "âŒ ERRO: Erros JavaScript detectados"
            ERRORS=$((ERRORS + 1))
          fi
          
          # 4. Verificar erros Next.js
          echo "âš›ï¸  4. Verificando erros Next.js..."
          if grep -qi "application error\|500\|404\|error occurred\|something went wrong" /tmp/page.html; then
            echo "âŒ ERRO: Mensagens de erro detectadas"
            ERRORS=$((ERRORS + 1))
          fi
          
          # 5. Verificar elementos crÃ­ticos
          echo "ğŸ® 5. Verificando elementos do jogo..."
          
          IMAGES_COUNT=$(grep -o 'src="[^"]*' /tmp/page.html | grep -E '\.(jpg|jpeg|png|gif|webp)' | wc -l || echo "0")
          echo "   ğŸ–¼ï¸  Imagens: $IMAGES_COUNT"
          
          if [[ "$IMAGES_COUNT" -lt 5 ]]; then
            echo "âŒ ERRO: Poucas imagens ($IMAGES_COUNT) - raspadinhas quebradas"
            ERRORS=$((ERRORS + 1))
          fi
          
          # Textos essenciais
          REQUIRED_TEXTS=("Raspadinha" "PrÃªmios" "Jogar" "Depositar" "Saldo")
          for text in "${REQUIRED_TEXTS[@]}"; do
            if ! grep -qi "$text" /tmp/page.html; then
              echo "âŒ ERRO: Texto '$text' nÃ£o encontrado"
              ERRORS=$((ERRORS + 1))
            fi
          done
          
          # 6. Verificar recursos
          JS_COUNT=$(grep -o '<script[^>]*src="[^"]*"' /tmp/page.html | wc -l || echo "0")
          CSS_COUNT=$(grep -o '<link[^>]*rel="stylesheet"' /tmp/page.html | wc -l || echo "0")
          
          echo "   ğŸ“œ Scripts: $JS_COUNT"
          echo "   ğŸ¨ Estilos: $CSS_COUNT"
          
          if [[ "$JS_COUNT" -lt 3 ]]; then
            echo "âŒ ERRO: Poucos scripts ($JS_COUNT)"
            ERRORS=$((ERRORS + 1))
          fi
          
          if [[ "$CSS_COUNT" -lt 2 ]]; then
            echo "âŒ ERRO: Poucos estilos ($CSS_COUNT)"
            ERRORS=$((ERRORS + 1))
          fi
          
          # 7. Verificar estrutura HTML
          if ! grep -q "<html" /tmp/page.html; then
            echo "âŒ ERRO: Tag HTML nÃ£o encontrada"
            ERRORS=$((ERRORS + 1))
          fi
          
          rm -f /tmp/page.html
          
          # Coletar detalhes dos erros para relatÃ³rio
          ERROR_DETAILS=""
          if [[ "$STATUS" != "200" ]]; then
            ERROR_DETAILS="${ERROR_DETAILS}â€¢ Site nÃ£o responde (HTTP $STATUS)%0A"
          fi
          if [[ "$PAGE_SIZE" -lt 10000 ]]; then
            ERROR_DETAILS="${ERROR_DETAILS}â€¢ PÃ¡gina muito pequena ($PAGE_SIZE bytes)%0A"
          fi
          if [[ "$IMAGES_COUNT" -lt 5 ]]; then
            ERROR_DETAILS="${ERROR_DETAILS}â€¢ Poucas imagens ($IMAGES_COUNT/5)%0A"
          fi
          if [[ "$JS_COUNT" -lt 3 ]]; then
            ERROR_DETAILS="${ERROR_DETAILS}â€¢ Poucos scripts JS ($JS_COUNT/3)%0A"
          fi
          if [[ "$CSS_COUNT" -lt 2 ]]; then
            ERROR_DETAILS="${ERROR_DETAILS}â€¢ Poucos arquivos CSS ($CSS_COUNT/2)%0A"
          fi
          
          # Salvar informaÃ§Ãµes para prÃ³ximo job
          echo "deploy_source=$DEPLOY_SOURCE" >> $GITHUB_OUTPUT
          echo "errors_count=$ERRORS" >> $GITHUB_OUTPUT
          echo "warnings_count=$WARNINGS" >> $GITHUB_OUTPUT
          echo "images_count=$IMAGES_COUNT" >> $GITHUB_OUTPUT
          echo "js_count=$JS_COUNT" >> $GITHUB_OUTPUT
          echo "css_count=$CSS_COUNT" >> $GITHUB_OUTPUT
          echo "error_details=$ERROR_DETAILS" >> $GITHUB_OUTPUT
          
          # Resultado
          echo ""
          echo "ğŸ“Š RESULTADO:"
          echo "âŒ Erros: $ERRORS"
          echo "âš ï¸  Avisos: $WARNINGS"
          
          if [[ "$ERRORS" -gt 0 ]]; then
            echo ""
            echo "ğŸš¨ HEALTH CHECK FALHOU!"
            echo "health_check_passed=false" >> $GITHUB_OUTPUT
            exit 1
          else
            echo ""
            echo "âœ… HEALTH CHECK PASSOU!"
            echo "health_check_passed=true" >> $GITHUB_OUTPUT
          fi

  # Job 3: Rollback (SEMPRE que health check falhar)
  rollback:
    runs-on: ubuntu-latest
    needs: [deploy, health-check]
    if: always() && needs.health-check.outputs.health_check_passed == 'false' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    
    steps:
      - name: ğŸ”„ Rollback AutomÃ¡tico
        run: |
          echo "ğŸš¨ EXECUTANDO ROLLBACK AUTOMÃTICO..."
          echo "Deploy automÃ¡tico falhou - revertendo"
          
          npm install -g vercel@latest
          
          echo "ğŸ” Buscando deployment anterior..."
          echo "ğŸ“‹ Listando Ãºltimos 10 deployments..."
          DEPLOYMENTS=$(npx vercel ls rasparei --token="${{ secrets.VERCEL_TOKEN }}" --scope="${{ secrets.VERCEL_SCOPE }}" -m 10)
          echo "ğŸ“Š Deployments encontrados:"
          echo "$DEPLOYMENTS"
          
          PREVIOUS_URL=$(echo "$DEPLOYMENTS" | grep -E "https://.*\.vercel\.app" | sed -n '2p' | awk '{print $1}')
          
          if [ -z "$PREVIOUS_URL" ]; then
            echo "âŒ Deployment anterior nÃ£o encontrado"
            echo "ğŸ” Tentando encontrar deployment estÃ¡vel..."
            
            # Buscar qualquer deployment que nÃ£o seja o atual
            STABLE_URL=$(echo "$DEPLOYMENTS" | grep -E "https://.*\.vercel\.app" | head -2 | tail -1 | awk '{print $1}')
            
            if [ -n "$STABLE_URL" ]; then
              echo "ğŸ”„ Usando deployment estÃ¡vel: $STABLE_URL"
              npx vercel promote "$STABLE_URL" --token="${{ secrets.VERCEL_TOKEN }}" --scope="${{ secrets.VERCEL_SCOPE }}" --yes
              echo "rollback_executed=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ Nenhum deployment disponÃ­vel para rollback"
              echo "rollback_executed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "ğŸ”„ Executando rollback para: $PREVIOUS_URL"
            npx vercel promote "$PREVIOUS_URL" --token="${{ secrets.VERCEL_TOKEN }}" --scope="${{ secrets.VERCEL_SCOPE }}" --yes
            
            if [ $? -eq 0 ]; then
              echo "âœ… ROLLBACK EXECUTADO COM SUCESSO!"
              echo "ğŸ§ª Aguardando 30 segundos para estabilizar..."
              sleep 30
              
              # Verificar se rollback funcionou
              echo "ğŸ” Verificando se rollback funcionou..."
              ROLLBACK_STATUS=$(curl -s -w "%{http_code}" -o /dev/null --max-time 30 "https://rasparei.com/" || echo "000")
              
              if [[ "$ROLLBACK_STATUS" == "200" ]]; then
                echo "âœ… ROLLBACK VERIFICADO - SITE FUNCIONANDO!"
                echo "rollback_executed=true" >> $GITHUB_OUTPUT
              else
                echo "âŒ ROLLBACK FALHOU - SITE AINDA COM PROBLEMAS (Status: $ROLLBACK_STATUS)"
                echo "rollback_executed=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "âŒ Comando de rollback falhou"
              echo "rollback_executed=false" >> $GITHUB_OUTPUT
            fi
          fi

  # Job 4: NotificaÃ§Ãµes (sempre executa)
  notify:
    runs-on: ubuntu-latest
    needs: [health-check, rollback]
    if: always()
    
    steps:
      - name: ğŸ“± Telegram Notification
        run: |
          HEALTH_PASSED="${{ needs.health-check.outputs.health_check_passed }}"
          DEPLOY_SOURCE="${{ needs.health-check.outputs.deploy_source }}"
          ERRORS="${{ needs.health-check.outputs.errors_count }}"
          IMAGES="${{ needs.health-check.outputs.images_count }}"
          ERROR_DETAILS="${{ needs.health-check.outputs.error_details }}"
          ROLLBACK="${{ needs.rollback.outputs.rollback_executed || 'nÃ£o executado' }}"
          
          if [[ "$HEALTH_PASSED" == "true" ]]; then
            # Sucesso
            MESSAGE="âœ… RaspaGanha V2 - FUNCIONANDO!%0A%0AğŸ® Site: https://rasparei.com/%0AğŸ” Health Check: PASSOU%0AğŸ–¼ï¸ Imagens: $IMAGES OK%0AğŸ“‹ Fonte: $DEPLOY_SOURCE%0A%0AğŸ“Š Commit: ${GITHUB_SHA:0:7}%0AğŸ•’ $(date +'%d/%m %H:%M')"
          else
            # Falha
            if [[ "$ROLLBACK" == "true" ]]; then
              MESSAGE="ğŸ”„ ROLLBACK EXECUTADO!%0A%0AğŸš¨ Deploy falhou ($ERRORS erros)%0Aâœ… Site revertido automaticamente%0AğŸ® https://rasparei.com/%0AğŸ“‹ Fonte: $DEPLOY_SOURCE%0A%0AğŸ“Š Commit: ${GITHUB_SHA:0:7}%0Aâœ… USUÃRIOS PROTEGIDOS!"
            else
              if [[ "${{ github.event_name }}" == "schedule" ]]; then
                MESSAGE="ğŸš¨ PROBLEMA DETECTADO!%0A%0AâŒ Health check falhou ($ERRORS erros)%0AğŸ” PossÃ­vel deploy manual problemÃ¡tico%0AğŸ® https://rasparei.com/%0A%0Aâš ï¸ VERIFIQUE MANUALMENTE!%0AUsuÃ¡rios podem estar afetados"
              else
                MESSAGE="ğŸš¨ DEPLOY FALHOU!%0A%0AâŒ Health check: $ERRORS erros detectados%0A%0AğŸ“‹ DETALHES DOS ERROS:%0A$ERROR_DETAILS%0AâŒ Rollback: $ROLLBACK%0AğŸ® https://rasparei.com/%0AğŸ“‹ Fonte: $DEPLOY_SOURCE%0AğŸ“Š Commit: ${GITHUB_SHA:0:7}%0A%0AğŸ”¥ INTERVENÃ‡ÃƒO NECESSÃRIA!%0Aâš ï¸ SITE PODE ESTAR COM PROBLEMAS!"
              fi
            fi
          fi
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=$MESSAGE"
